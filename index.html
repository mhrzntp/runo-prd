<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    select, input, button {
      padding: 5px;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product (Commercial)</th>
    <th>Quantity (pcs)</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">➕ Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadCSV()">Download BOM (CSV)</button>

<h3>Bill of Materials</h3>
<table id="bomTable">
  <tr>
    <th>Material</th>
    <th>Quantity</th>
    <th>Unit</th>
  </tr>
</table>

<script>
/* ---------- PRODUCT MASTER ---------- */
const products = {
  "Toraja Soul": { bean: "Toraja Sapan" },
  "Gayo Sunset": { bean: "Gayo Wine" },
  "Preanger Sweets": { bean: "Red Preanger" },
  "Ijen Dawn": { bean: "Ijen Raung" },
  "Kerinci Breeze": { bean: "Kerinci" },
  "Sumatera Classic": { bean: "Lampung Jantan" }
};

/* ---------- RULES ---------- */
const DRIP_DOSE = 10; // g per bag

/* ---------- UI ---------- */
function addRow() {
  const table = document.getElementById("planTable");
  const row = table.insertRow();

  row.innerHTML = `
    <td>
      <select>
        <option>Beans</option>
        <option>Ground</option>
        <option>Drip</option>
      </select>
    </td>
    <td>
      <select>
        <option>100</option>
        <option>200</option>
        <option>500</option>
        <option>5</option>
        <option>10</option>
      </select>
    </td>
    <td>
      <select>
        ${Object.keys(products).map(p => `<option>${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" value="1" min="1"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">❌</button></td>
  `;
}

addRow();

/* ---------- BOM LOGIC ---------- */
let bomResult = {};

function addMaterial(name, qty, unit) {
  if (!bomResult[name]) {
    bomResult[name] = { qty: 0, unit };
  }
  bomResult[name].qty += qty;
}

function generateBOM() {
  bomResult = {};
  const rows = document.querySelectorAll("#planTable tr");
  
  rows.forEach((row, index) => {
    if (index === 0) return;

    const variant = row.cells[0].children[0].value;
    const size = Number(row.cells[1].children[0].value);
    const productName = row.cells[2].children[0].value;
    const qty = Number(row.cells[3].children[0].value);
    const bean = products[productName].bean;

    if (variant === "Beans" || variant === "Ground") {
      addMaterial(`${bean} ${variant.toLowerCase()} coffee`, size * qty, "g");
      addMaterial("Valve bag", qty, "pcs");
      addMaterial("Branding label", qty, "pcs");
    }

    if (variant === "Drip") {
      const coffeeNeeded = size * DRIP_DOSE * qty;
      addMaterial(`${bean} ground coffee`, coffeeNeeded, "g");
      addMaterial("Drip filter", size * qty, "pcs");
      addMaterial("Standing pouch", qty, "pcs");
      addMaterial("Branding label", qty, "pcs");
      addMaterial("Instruction label", qty, "pcs");
    }
  });

  renderBOM();
}

function renderBOM() {
  const table = document.getElementById("bomTable");
  table.innerHTML = `
    <tr>
      <th>Material</th>
      <th>Quantity</th>
      <th>Unit</th>
    </tr>
  `;

  for (let item in bomResult) {
    const row = table.insertRow();
    row.innerHTML = `
      <td>${item}</td>
      <td>${bomResult[item].qty}</td>
      <td>${bomResult[item].unit}</td>
    `;
  }
}

/* ---------- CSV DOWNLOAD ---------- */
function downloadCSV() {
  let csv = "Material,Quantity,Unit\n";
  for (let item in bomResult) {
    csv += `${item},${bomResult[item].qty},${bomResult[item].unit}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "runo-bom.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>