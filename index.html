<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>

  <style>
    :root {
      --accent-red: #D62B2B;
      --text-black: #000000;
      --text-white: #FFFFFF;
      --border-light: #ddd;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Arial, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      background: #faf9f7;
      color: var(--text-black);
    }

    h2 {
      font-size: 30px;
      margin-bottom: 5px;
      text-align: center;
    }

    h3 {
      margin-top: 40px;
      font-size: 20px;
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    }

    th {
      background: var(--accent-red);
      color: var(--text-white) !important;
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 13px;
      text-transform: uppercase;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    tr:last-child td {
      border-bottom: none;
    }

    select,
    input {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      font-size: 14px;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: var(--accent-red);
      box-shadow: 0 0 0 2px rgba(214,43,43,0.15);
    }

    /* PRIMARY BUTTONS */
    button {
      background: var(--accent-red);
      color: var(--text-white);
      border: 1px solid var(--accent-red);
      border-radius: 10px;
      font-size: 14px;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      opacity: 0.9;
    }

    button:active {
      transform: translateY(1px);
    }

    /* ADD PRODUCT BUTTON */
    .add-btn {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .add-btn .plus {
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
      color: var(--text-white);
    }

    /* ROW ACTION BUTTONS */
    .action-btn {
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px 6px;
      color: var(--accent-red);
    }

    .action-btn.delete {
      color: var(--text-black);
    }

    .action-btn:hover {
      opacity: 0.7;
    }

    .meta {
      margin-top: 25px;
      padding: 16px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .costbox {
      margin-top: 25px;
      padding: 20px;
      background: var(--accent-red);
      color: var(--text-white);
      font-size: 22px;
      font-weight: 700;
      border-radius: 14px;
    }

    #totalCost {
      font-size: 26px;
      letter-spacing: 0.03em;
    }

    pre {
      background: #ffffff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      white-space: pre-wrap;
      font-size: 13px;
    }
  </style>
</head>

<body>

<h2>RUNO</h2>
<p style="text-align:center; margin-top:-8px; opacity:0.7;">Production Planner</p>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<div style="margin:15px 0; display:flex; gap:10px; flex-wrap:wrap;">
  <button class="add-btn" onclick="addRow()">
    <span class="plus">+</span> Add Product
  </button>
  <button onclick="generateBOM()">‚öôÔ∏è Generate BoM</button>
  <button onclick="downloadBOM()">‚¨áÔ∏è Download CSV</button>
  <button onclick="saveBOM()">üíæ Save BoM</button>
</div>

<div class="meta">
  <strong>BoM Name:</strong> <span id="bomName">-</span><br>
  <strong>Generated At:</strong> <span id="generatedAt">-</span>
</div>

<h3>üßæ Summary (Saved to Google Sheets)</h3>
<pre id="summaryText"></pre>

<div class="costbox">
  Total Cost: <span id="totalCost">0</span>
</div>

<script>
/* ========= CONFIG ========= */
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycby5wEVeFeCFuY43vZH_tG1U2jXc-3ZQyfaADCnPxBKS-5RwiP37oC0ciMNNkLL8eqHNVA/exec";

const PRODUCTS = {
  "Toraja Soul": "Toraja Sapan",
  "Gayo Sunset": "Gayo Wine",
  "Preanger Sweets": "Red Preanger",
  "Ijen Dawn": "Ijen Raung",
  "Kerinci Breeze": "Kerinci",
  "Sumatera Classic": "Lampung Jantan"
};

const DRIP_DOSE = 10;

/* ========= STATE ========= */
let summaryText = "";
let bomName = "";
let generatedAt = "";

/* ========= UTIL ========= */
function buildBoMName(d){
  const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `BOM_${String(d.getDate()).padStart(2,"0")}-${m[d.getMonth()]}-${String(d.getFullYear()).slice(-2)}`;
}

function sizeOptions(v){
  return v==="Drip" ? ["1pc","5","10"] : ["18g","100","200","500"];
}

/* ========= UI ========= */
function addRow(values=null){
  const t=document.getElementById("planTable");
  const r=t.insertRow(-1);
  r.innerHTML=`
    <td>
      <select onchange="updateSize(this)">
        <option>Beans</option>
        <option>Ground</option>
        <option>Drip</option>
      </select>
    </td>
    <td><select></select></td>
    <td>
      <select>
        ${Object.keys(PRODUCTS).map(p=>`<option>${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" value="1" min="1"></td>
    <td>
      <button class="action-btn" onclick="copyRow(this)" title="Copy">üìÑ</button>
      <button class="action-btn delete" onclick="this.parentElement.parentElement.remove()" title="Delete">‚ùå</button>
    </td>
  `;
  updateSize(r.cells[0].children[0]);
}

function copyRow(btn){
  const r=btn.parentElement.parentElement;
  addRow({
    v:r.cells[0].children[0].value,
    s:r.cells[1].children[0].value,
    p:r.cells[2].children[0].value,
    q:r.cells[3].children[0].value
  });
}

function updateSize(sel){
  const s=sel.parentElement.parentElement.cells[1].children[0];
  s.innerHTML="";
  sizeOptions(sel.value).forEach(v=>{
    const o=document.createElement("option");
    o.textContent=v;
    s.appendChild(o);
  });
}

addRow();

/* ========= BOM ========= */
function generateBOM(){
  const now=new Date();
  bomName=buildBoMName(now);
  generatedAt=now.toLocaleString();

  document.getElementById("bomName").textContent=bomName;
  document.getElementById("generatedAt").textContent=generatedAt;

  let lines=[];
  document.querySelectorAll("#planTable tr").forEach((r,i)=>{
    if(i===0) return;
    const v=r.cells[0].children[0].value;
    const s=r.cells[1].children[0].value;
    const p=r.cells[2].children[0].value;
    const q=r.cells[3].children[0].value;
    lines.push(`${q} x ${p} (${v}, ${s})`);
  });

  summaryText = lines.join("\n");
  document.getElementById("summaryText").textContent = summaryText;
  document.getElementById("totalCost").textContent = "0";
}

/* ========= SAVE ========= */
function saveBOM(){
  if(!bomName){
    alert("Generate BoM first");
    return;
  }

  const params=new URLSearchParams({
    bomName,
    generatedAt,
    summary: summaryText,
    totalCost: "0"
  });

  const iframe=document.createElement("iframe");
  iframe.style.display="none";
  iframe.src = SCRIPT_URL + "?" + params.toString();
  document.body.appendChild(iframe);

  alert("BoM saved successfully ‚úÖ");
}

/* ========= CSV ========= */
function downloadBOM(){
  let csv=`${bomName}\nGenerated at: ${generatedAt}\n\n${summaryText}`;
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`${bomName}.csv`;
  a.click();
}
</script>

</body>
</html>
