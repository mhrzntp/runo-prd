<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body { font-family: Arial; max-width: 1000px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    select, input, button { padding: 5px; }
    details { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
    summary { font-weight: bold; cursor: pointer; }
    .meta { margin-top: 15px; padding: 10px; background: #f5f5f5; }
    .costbox { margin-top: 20px; padding: 15px; background: #e8f5e9; }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadBOM()">Download BOM (CSV)</button>
<button onclick="downloadPricingTemplate()">Download Pricing Template</button>

<div class="meta">
  <strong>BoM Name:</strong> <span id="bomName">-</span><br>
  <strong>Generated at:</strong> <span id="generatedAt">-</span><br><br>
  <strong>Production Summary:</strong>
  <ul id="summaryList"></ul>
</div>

<h3>üßæ Procurement Summary</h3>
<table id="procurementTable"></table>

<details open><summary>‚òï Coffee</summary><table id="coffeeTable"></table></details>
<details open><summary>üì¶ Packaging</summary><table id="packagingTable"></table></details>
<details open><summary>üè∑Ô∏è Labels</summary><table id="labelTable"></table></details>

<div class="costbox">
  <strong>Cost Summary</strong><br>
  Coffee: <span id="coffeeCost">0</span><br>
  Packaging: <span id="packagingCost">0</span><br>
  Labels: <span id="labelCost">0</span><br><br>
  <strong>Total Cost: <span id="totalCost">0</span></strong>
</div>

<script>
/* ===== MASTER DATA ===== */
const products = {
  "Toraja Soul": "Toraja Sapan",
  "Gayo Sunset": "Gayo Wine",
  "Preanger Sweets": "Red Preanger",
  "Ijen Dawn": "Ijen Raung",
  "Kerinci Breeze": "Kerinci",
  "Sumatera Classic": "Lampung Jantan"
};

const DRIP_DOSE = 10;
const SACHET_DOSE = 18;

let bom = { coffee:{}, packaging:{}, label:{} };
let pricing = {};
let summaryText = [];
let generatedTime = "";
let bomName = "";

/* ===== AUTO LOAD PRICING (comma + semicolon safe) ===== */
fetch("pricing.csv")
  .then(r => r.ok ? r.text() : "")
  .then(t => {
    if (!t) return;
    t.trim().split("\n").slice(1).forEach(l => {
      if (!l.trim()) return;
      const parts = l.includes(";") ? l.split(";") : l.split(",");
      const [cat, mat, price] = parts.map(p => p.trim());
      pricing[`${cat}|${mat}`] = Number(price) || 0;
    });
  });

/* ===== UTIL: BUILD BOM NAME ===== */
function buildBoMName(date) {
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const dd = String(date.getDate()).padStart(2, "0");
  const mmm = months[date.getMonth()];
  const yy = String(date.getFullYear()).slice(-2);
  return `BoM-${dd}-${mmm}-${yy}`;
}

/* ===== SIZE OPTIONS ===== */
function getSizeOptions(v) {
  return v === "Drip"
    ? [{v:"1pc",l:"1 pc"},{v:"5",l:"5 pcs"},{v:"10",l:"10 pcs"}]
    : [{v:"18g",l:"18 g"},{v:"100",l:"100 g"},{v:"200",l:"200 g"},{v:"500",l:"500 g"}];
}

/* ===== UI ===== */
function addRow(values=null, after=null){
  const t=document.getElementById("planTable");
  const r=t.insertRow(after?after.rowIndex+1:-1);
  r.innerHTML=`
    <td><select onchange="updateSize(this)"><option>Beans</option><option>Ground</option><option>Drip</option></select></td>
    <td><select></select></td>
    <td><select>${Object.keys(products).map(p=>`<option>${p}</option>`).join("")}</select></td>
    <td><input type="number" value="1" min="1"></td>
    <td>
      <button onclick="copyRow(this)">üìÑ</button>
      <button onclick="this.parentElement.parentElement.remove()">‚ùå</button>
    </td>`;
  updateSize(r.cells[0].children[0]);
  if(values){
    r.cells[0].children[0].value=values.variant;
    updateSize(r.cells[0].children[0]);
    r.cells[1].children[0].value=values.size;
    r.cells[2].children[0].value=values.product;
    r.cells[3].children[0].value=values.qty;
  }
}
addRow();

function copyRow(btn){
  const r=btn.parentElement.parentElement;
  addRow({
    variant:r.cells[0].children[0].value,
    size:r.cells[1].children[0].value,
    product:r.cells[2].children[0].value,
    qty:r.cells[3].children[0].value
  },r);
}

function updateSize(sel){
  const s=sel.parentElement.parentElement.cells[1].children[0];
  s.innerHTML="";
  getSizeOptions(sel.value).forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.v; opt.textContent=o.l; s.appendChild(opt);
  });
}

/* ===== BOM ===== */
function add(group,name,qty){
  if(!bom[group][name]) bom[group][name]={qty:0,cost:0};
  bom[group][name].qty+=qty;
}

function generateBOM(){
  bom={coffee:{},packaging:{},label:{}};
  summaryText=[];
  document.getElementById("summaryList").innerHTML="";

  const now = new Date();
  generatedTime = now.toLocaleString();
  bomName = buildBoMName(now);

  document.getElementById("generatedAt").textContent = generatedTime;
  document.getElementById("bomName").textContent = bomName;

  document.querySelectorAll("#planTable tr").forEach((r,i)=>{
    if(i===0) return;
    const v=r.cells[0].children[0].value;
    const s=r.cells[1].children[0].value;
    const p=r.cells[2].children[0].value;
    const q=Number(r.cells[3].children[0].value);
    const bean=products[p];

    summaryText.push(`${v} ${s} ‚Äì ${p} √ó ${q}`);
    document.getElementById("summaryList").innerHTML+=
      `<li>${v} ${s} ‚Äì ${p} √ó ${q}</li>`;

    let ck="", cq=0;
    if(v==="Beans"){ck=`${bean} beans`; cq=s==="18g"?18*q:Number(s)*q;}
    if(v==="Ground"){ck=`${bean} ground coffee`; cq=s==="18g"?18*q:Number(s)*q;}
    if(v==="Drip"){ck=`${bean} beans`; cq=s==="1pc"?10*q:Number(s)*10*q;}
    add("coffee",ck,cq);

    if(s==="18g"||s==="1pc") add("packaging","S size sachet",q);
    else if((v==="Drip"&&s==="5")||(v!=="Drip"&&Number(s)<=200))
      add("packaging","M size bag",q);
    else add("packaging","L size bag",q);

    if(v==="Drip")
      add("packaging","Drip filter",s==="1pc"?q:Number(s)*q);

    add("label",`${p} ‚Äì ${v}`,q);
    if(v==="Drip") add("label","Instruction label",q);
  });

  calculateCost();
  renderAll();
  renderProcurement();
}

/* ===== COST ===== */
function calculateCost(){
  let totals={coffee:0,packaging:0,label:0};
  for(let g in bom){
    for(let m in bom[g]){
      const p=pricing[`${g}|${m}`]||0;
      const c=bom[g][m].qty*p;
      bom[g][m].cost=c;
      totals[g]+=c;
    }
  }
  document.getElementById("coffeeCost").textContent=totals.coffee.toLocaleString();
  document.getElementById("packagingCost").textContent=totals.packaging.toLocaleString();
  document.getElementById("labelCost").textContent=totals.label.toLocaleString();
  document.getElementById("totalCost").textContent=
    (totals.coffee+totals.packaging+totals.label).toLocaleString();
}

/* ===== RENDER ===== */
function renderAll(){
  ["coffee","packaging","label"].forEach(g=>{
    const t=document.getElementById(g+"Table");
    t.innerHTML="<tr><th>Material</th><th>Qty</th><th>Cost</th></tr>";
    for(let m in bom[g])
      t.innerHTML+=
        `<tr><td>${m}</td><td>${bom[g][m].qty}</td><td>${bom[g][m].cost.toLocaleString()}</td></tr>`;
  });
}

function renderProcurement(){
  const t=document.getElementById("procurementTable");
  t.innerHTML="<tr><th>Material</th><th>Total Qty</th><th>Total Cost</th></tr>";
  let merged={};

  for(let g in bom){
    for(let m in bom[g]){
      if(!merged[m]) merged[m]={qty:0,cost:0};
      merged[m].qty+=bom[g][m].qty;
      merged[m].cost+=bom[g][m].cost;
    }
  }

  for(let m in merged){
    t.innerHTML+=
      `<tr><td>${m}</td><td>${merged[m].qty}</td><td>${merged[m].cost.toLocaleString()}</td></tr>`;
  }
}

/* ===== CSV ===== */
function downloadBOM(){
  let csv=`# ${bomName}\n# Generated at: ${generatedTime}\n`;
  summaryText.forEach(s=>csv+=`# ${s}\n`);
  csv+=`\nCategory,Material,Quantity,Cost\n`;
  for(let g in bom)
    for(let m in bom[g])
      csv+=`${g},${m},${bom[g][m].qty},${bom[g][m].cost}\n`;

  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`${bomName}.csv`;
  a.click();
}

function downloadPricingTemplate(){
  let r=["category,material,price_per_unit"];
  Object.values(products).forEach(b=>{
    r.push(`coffee,${b} beans,`);
    r.push(`coffee,${b} ground coffee,`);
  });
  r.push("packaging,S size sachet,","packaging,M size bag,","packaging,L size bag,","packaging,Drip filter,","label,Instruction label,");
  Object.keys(products).forEach(p=>{
    r.push(`label,${p} ‚Äì Beans,`,`label,${p} ‚Äì Ground,`,`label,${p} ‚Äì Drip,`);
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([r.join("\n")],{type:"text/csv"}));
  a.download="pricing-template.csv";
  a.click();
}
</script>

</body>
</html>
