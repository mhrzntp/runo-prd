<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    select, input, button {
      padding: 5px;
    }
    details {
      margin-top: 15px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadCSV()">Download BOM (CSV)</button>

<!-- BOM OUTPUT -->
<details open>
  <summary>‚òï Coffee</summary>
  <table id="coffeeTable"></table>
</details>

<details open>
  <summary>üì¶ Packaging</summary>
  <table id="packagingTable"></table>
</details>

<details open>
  <summary>üè∑Ô∏è Labels</summary>
  <table id="labelTable"></table>
</details>

<script>
/* ---------- PRODUCT MASTER ---------- */
const products = {
  "Toraja Soul": { bean: "Toraja Sapan" },
  "Gayo Sunset": { bean: "Gayo Wine" },
  "Preanger Sweets": { bean: "Red Preanger" },
  "Ijen Dawn": { bean: "Ijen Raung" },
  "Kerinci Breeze": { bean: "Kerinci" },
  "Sumatera Classic": { bean: "Lampung Jantan" }
};

const DRIP_DOSE = 10;

/* ---------- UI ---------- */
function addRow() {
  const table = document.getElementById("planTable");
  const row = table.insertRow();

  row.innerHTML = `
    <td>
      <select>
        <option>Beans</option>
        <option>Ground</option>
        <option>Drip</option>
      </select>
    </td>
    <td>
      <select>
        <option>100</option>
        <option>200</option>
        <option>500</option>
        <option>5</option>
        <option>10</option>
      </select>
    </td>
    <td>
      <select>
        ${Object.keys(products).map(p => `<option>${p}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" value="1" min="1"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">‚ùå</button></td>
  `;
}

addRow();

/* ---------- BOM ---------- */
let bom = {
  coffee: {},
  packaging: {},
  label: {}
};

function add(group, name, qty, unit) {
  if (!bom[group][name]) {
    bom[group][name] = { qty: 0, unit };
  }
  bom[group][name].qty += qty;
}

function generateBOM() {
  bom = { coffee: {}, packaging: {}, label: {} };
  const rows = document.querySelectorAll("#planTable tr");

  rows.forEach((row, i) => {
    if (i === 0) return;

    const variant = row.cells[0].children[0].value;
    const size = Number(row.cells[1].children[0].value);
    const product = row.cells[2].children[0].value;
    const qty = Number(row.cells[3].children[0].value);
    const bean = products[product].bean;

    if (variant === "Beans" || variant === "Ground") {
      add("coffee", `${bean} ${variant.toLowerCase()} coffee`, size * qty, "g");
      add("packaging", "Valve bag", qty, "pcs");
      add("label", "Branding label", qty, "pcs");
    }

    if (variant === "Drip") {
      add("coffee", `${bean} ground coffee`, size * DRIP_DOSE * qty, "g");
      add("packaging", "Drip filter", size * qty, "pcs");
      add("packaging", "Standing pouch", qty, "pcs");
      add("label", "Branding label", qty, "pcs");
      add("label", "Instruction label", qty, "pcs");
    }
  });

  render("coffeeTable", bom.coffee);
  render("packagingTable", bom.packaging);
  render("labelTable", bom.label);
}

function render(tableId, data) {
  const table = document.getElementById(tableId);
  table.innerHTML = `
    <tr>
      <th>Material</th>
      <th>Qty</th>
      <th>Unit</th>
    </tr>
  `;

  for (let item in data) {
    const row = table.insertRow();
    row.innerHTML = `
      <td>${item}</td>
      <td>${data[item].qty}</td>
      <td>${data[item].unit}</td>
    `;
  }
}

/* ---------- CSV EXPORT ---------- */
function downloadCSV() {
  let csv = "Category,Material,Quantity,Unit\n";

  for (let group in bom) {
    for (let item in bom[group]) {
      csv += `${group},${item},${bom[group][item].qty},${bom[group][item].unit}\n`;
    }
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "runo-bom.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
