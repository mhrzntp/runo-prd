<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 30px auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    select, input, button {
      padding: 5px;
    }
    details {
      margin-top: 15px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
    }
    .meta {
      margin-top: 15px;
      padding: 10px;
      background: #f5f5f5;
    }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadCSV()">Download BOM (CSV)</button>

<div class="meta">
  <strong>Generated at:</strong> <span id="generatedAt">-</span>
  <br><br>
  <strong>Production Summary:</strong>
  <ul id="summaryList"></ul>
</div>

<details open>
  <summary>‚òï Coffee</summary>
  <table id="coffeeTable"></table>
</details>

<details open>
  <summary>üì¶ Packaging</summary>
  <table id="packagingTable"></table>
</details>

<details open>
  <summary>üè∑Ô∏è Labels</summary>
  <table id="labelTable"></table>
</details>

<script>
const products = {
  "Toraja Soul": { bean: "Toraja Sapan" },
  "Gayo Sunset": { bean: "Gayo Wine" },
  "Preanger Sweets": { bean: "Red Preanger" },
  "Ijen Dawn": { bean: "Ijen Raung" },
  "Kerinci Breeze": { bean: "Kerinci" },
  "Sumatera Classic": { bean: "Lampung Jantan" }
};

const DRIP_DOSE = 10;

let bom = { coffee: {}, packaging: {}, label: {} };
let summaryText = [];
let generatedTime = "";

function getSizeOptions(variant) {
  return variant === "Drip"
    ? [{ v: 5, l: "5 pcs" }, { v: 10, l: "10 pcs" }]
    : [{ v: 100, l: "100 g" }, { v: 200, l: "200 g" }, { v: 500, l: "500 g" }];
}

function addRow() {
  const row = document.getElementById("planTable").insertRow();
  row.innerHTML = `
    <td><select onchange="updateSizeOptions(this)"><option>Beans</option><option>Ground</option><option>Drip</option></select></td>
    <td><select></select></td>
    <td><select>${Object.keys(products).map(p => `<option>${p}</option>`).join("")}</select></td>
    <td><input type="number" value="1" min="1"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">‚ùå</button></td>
  `;
  updateSizeOptions(row.cells[0].children[0]);
}

function updateSizeOptions(sel) {
  const sizeSel = sel.parentElement.parentElement.cells[1].children[0];
  sizeSel.innerHTML = "";
  getSizeOptions(sel.value).forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.v;
    opt.textContent = o.l;
    sizeSel.appendChild(opt);
  });
  sizeSel.selectedIndex = 0;
}

addRow();

function add(group, name, qty, unit) {
  if (!bom[group][name]) bom[group][name] = { qty: 0, unit };
  bom[group][name].qty += qty;
}

function generateBOM() {
  bom = { coffee: {}, packaging: {}, label: {} };
  summaryText = [];
  document.getElementById("summaryList").innerHTML = "";

  generatedTime = new Date().toLocaleString();
  document.getElementById("generatedAt").textContent = generatedTime;

  document.querySelectorAll("#planTable tr").forEach((row, i) => {
    if (i === 0) return;

    const variant = row.cells[0].children[0].value;
    const size = Number(row.cells[1].children[0].value);
    const product = row.cells[2].children[0].value;
    const qty = Number(row.cells[3].children[0].value);
    const bean = products[product].bean;

    const sizeLabel = variant === "Drip" ? `${size} pcs` : `${size} g`;
    const line = `${variant} ${sizeLabel} ‚Äì ${product} √ó ${qty}`;
    summaryText.push(line);

    const li = document.createElement("li");
    li.textContent = line;
    document.getElementById("summaryList").appendChild(li);

    if (variant === "Beans") {
      add("coffee", `${bean} beans`, size * qty, "g");
      add("packaging", "Valve bag", qty, "pcs");
      add("label", `${product} ‚Äì Beans`, qty, "pcs");
    }

    if (variant === "Ground") {
      add("coffee", `${bean} ground coffee`, size * qty, "g");
      add("packaging", "Valve bag", qty, "pcs");
      add("label", `${product} ‚Äì Ground`, qty, "pcs");
    }

    if (variant === "Drip") {
      add("coffee", `${bean} beans`, size * DRIP_DOSE * qty, "g");
      add("packaging", "Drip filter", size * qty, "pcs");
      add("packaging", "Standing pouch", qty, "pcs");
      add("label", `${product} ‚Äì Drip`, qty, "pcs");
      add("label", "Instruction label", qty, "pcs");
    }
  });

  render("coffeeTable", bom.coffee);
  render("packagingTable", bom.packaging);
  render("labelTable", bom.label);
}

function render(id, data) {
  const t = document.getElementById(id);
  t.innerHTML = "<tr><th>Material</th><th>Qty</th><th>Unit</th></tr>";
  for (let k in data) {
    const r = t.insertRow();
    r.innerHTML = `<td>${k}</td><td>${data[k].qty}</td><td>${data[k].unit}</td>`;
  }
}

function downloadCSV() {
  let csv = `# Runo Production BOM\n# Generated at: ${generatedTime}\n`;
  summaryText.forEach(s => csv += `# ${s}\n`);
  csv += "\nCategory,Material,Quantity,Unit\n";

  for (let g in bom) {
    for (let i in bom[g]) {
      csv += `${g},${i},${bom[g][i].qty},${bom[g][i].unit}\n`;
    }
  }

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = "runo-bom.csv";
  a.click();
}
</script>

</body>
</html>
