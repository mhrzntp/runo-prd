<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    select, input, button { padding: 5px; }
    details { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
    summary { font-weight: bold; cursor: pointer; }
    .meta { margin-top: 15px; padding: 10px; background: #f5f5f5; }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadCSV()">Download BOM (CSV)</button>

<div class="meta">
  <strong>Generated at:</strong> <span id="generatedAt">-</span><br><br>
  <strong>Production Summary:</strong>
  <ul id="summaryList"></ul>
</div>

<details open><summary>‚òï Coffee</summary><table id="coffeeTable"></table></details>
<details open><summary>üì¶ Packaging</summary><table id="packagingTable"></table></details>
<details open><summary>üè∑Ô∏è Labels</summary><table id="labelTable"></table></details>

<script>
const products = {
  "Toraja Soul": "Toraja Sapan",
  "Gayo Sunset": "Gayo Wine",
  "Preanger Sweets": "Red Preanger",
  "Ijen Dawn": "Ijen Raung",
  "Kerinci Breeze": "Kerinci",
  "Sumatera Classic": "Lampung Jantan"
};

const DRIP_DOSE = 10;
const SACHET_DOSE = 18;

let bom, summaryText, generatedTime;

/* ---------- SIZE OPTIONS ---------- */
function getSizeOptions(variant) {
  if (variant === "Drip") {
    return [
      { v: "1pc", l: "1 pc" },
      { v: "5", l: "5 pcs" },
      { v: "10", l: "10 pcs" }
    ];
  }
  return [
    { v: "18g", l: "18 g" },
    { v: "100", l: "100 g" },
    { v: "200", l: "200 g" },
    { v: "500", l: "500 g" }
  ];
}

/* ---------- UI ---------- */
function addRow() {
  const row = document.getElementById("planTable").insertRow();
  row.innerHTML = `
    <td>
      <select onchange="updateSize(this)">
        <option>Beans</option>
        <option>Ground</option>
        <option>Drip</option>
      </select>
    </td>
    <td><select></select></td>
    <td><select>${Object.keys(products).map(p => `<option>${p}</option>`).join("")}</select></td>
    <td><input type="number" value="1" min="1"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">‚ùå</button></td>
  `;
  updateSize(row.cells[0].children[0]);
}
addRow();

function updateSize(sel) {
  const sizeSel = sel.parentElement.parentElement.cells[1].children[0];
  sizeSel.innerHTML = "";
  getSizeOptions(sel.value).forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.v;
    opt.textContent = o.l;
    sizeSel.appendChild(opt);
  });
  sizeSel.selectedIndex = 0;
}

/* ---------- BOM HELPERS ---------- */
function resetBOM() {
  bom = { coffee: {}, packaging: {}, label: {} };
  summaryText = [];
}

function add(group, key, qty, unit) {
  if (!bom[group][key]) bom[group][key] = { qty: 0, unit };
  bom[group][key].qty += qty;
}

/* ---------- MAIN LOGIC ---------- */
function generateBOM() {
  resetBOM();
  document.getElementById("summaryList").innerHTML = "";

  generatedTime = new Date().toLocaleString();
  document.getElementById("generatedAt").textContent = generatedTime;

  document.querySelectorAll("#planTable tr").forEach((r, i) => {
    if (i === 0) return;

    const variant = r.cells[0].children[0].value;
    const size = r.cells[1].children[0].value;
    const product = r.cells[2].children[0].value;
    const qty = Number(r.cells[3].children[0].value);
    const bean = products[product];

    const sizeLabel = size === "18g" ? "18 g"
                     : size === "1pc" ? "1 pc"
                     : `${size} ${variant === "Drip" ? "pcs" : "g"}`;

    summaryText.push(`${variant} ${sizeLabel} ‚Äì ${product} √ó ${qty}`);
    document.getElementById("summaryList").innerHTML += `<li>${variant} ${sizeLabel} ‚Äì ${product} √ó ${qty}</li>`;

    /* ---- COFFEE ---- */
    let coffeeKey, coffeeQty;
    if (variant === "Beans") {
      coffeeKey = `${bean} beans`;
      coffeeQty = size === "18g" ? SACHET_DOSE * qty : Number(size) * qty;
    }
    if (variant === "Ground") {
      coffeeKey = `${bean} ground coffee`;
      coffeeQty = size === "18g" ? SACHET_DOSE * qty : Number(size) * qty;
    }
    if (variant === "Drip") {
      coffeeKey = `${bean} beans`;
      coffeeQty = size === "1pc" ? DRIP_DOSE * qty : Number(size) * DRIP_DOSE * qty;
    }
    add("coffee", coffeeKey, coffeeQty, "g");

    /* ---- PACKAGING ---- */
    let pack;
    if (size === "18g" || size === "1pc") pack = "S size sachet";
    else if ((variant === "Drip" && size === "5") || (variant !== "Drip" && Number(size) <= 200))
      pack = "M size bag";
    else pack = "L size bag";
    add("packaging", pack, qty, "pcs");

    if (variant === "Drip") {
      add("packaging", "Drip filter", size === "1pc" ? qty : Number(size) * qty, "pcs");
    }

    /* ---- LABELS ---- */
    add("label", `${product} ‚Äì ${variant}`, qty, "pcs");
    if (variant === "Drip") add("label", "Instruction label", qty, "pcs");
  });

  render("coffeeTable", bom.coffee);
  render("packagingTable", bom.packaging);
  render("labelTable", bom.label);
}

/* ---------- RENDER ---------- */
function render(id, data) {
  const t = document.getElementById(id);
  t.innerHTML = "<tr><th>Material</th><th>Qty</th><th>Unit</th></tr>";
  for (let k in data)
    t.innerHTML += `<tr><td>${k}</td><td>${data[k].qty}</td><td>${data[k].unit}</td></tr>`;
}

/* ---------- CSV ---------- */
function downloadCSV() {
  let csv = `# Runo Production BOM\n# Generated at: ${generatedTime}\n`;
  summaryText.forEach(s => csv += `# ${s}\n`);
  csv += "\nCategory,Material,Quantity,Unit\n";
  for (let g in bom)
    for (let i in bom[g])
      csv += `${g},${i},${bom[g][i].qty},${bom[g][i].unit}\n`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = "runo-bom.csv";
  a.click();
}
</script>

</body>
</html>
