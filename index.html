<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    select, input, button { padding: 5px; }
    details { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
    summary { font-weight: bold; cursor: pointer; }
    .meta { margin-top: 15px; padding: 10px; background: #f5f5f5; }
    .costbox { margin-top: 20px; padding: 15px; background: #e8f5e9; }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="loadPricing()">üí∞ Load Pricing</button>
<button onclick="downloadCSV()">Download BOM (CSV)</button>

<div class="meta">
  <strong>Generated at:</strong> <span id="generatedAt">-</span><br><br>
  <strong>Production Summary:</strong>
  <ul id="summaryList"></ul>
</div>

<details open><summary>‚òï Coffee</summary><table id="coffeeTable"></table></details>
<details open><summary>üì¶ Packaging</summary><table id="packagingTable"></table></details>
<details open><summary>üè∑Ô∏è Labels</summary><table id="labelTable"></table></details>

<div class="costbox">
  <strong>Cost Summary</strong><br>
  Coffee: <span id="coffeeCost">-</span><br>
  Packaging: <span id="packagingCost">-</span><br>
  Labels: <span id="labelCost">-</span><br><br>
  <strong>Total Cost: <span id="totalCost">-</span></strong>
</div>

<script>
/* ========= MASTER ========= */
const products = {
  "Toraja Soul": "Toraja Sapan",
  "Gayo Sunset": "Gayo Wine",
  "Preanger Sweets": "Red Preanger",
  "Ijen Dawn": "Ijen Raung",
  "Kerinci Breeze": "Kerinci",
  "Sumatera Classic": "Lampung Jantan"
};

const DRIP_DOSE = 10;
const SACHET_DOSE = 18;

let bom = { coffee:{}, packaging:{}, label:{} };
let pricing = {};
let summaryText = [];
let generatedTime = "";

/* ========= SIZE ========= */
function getSizeOptions(v) {
  if (v === "Drip") return [{v:"1pc",l:"1 pc"},{v:"5",l:"5 pcs"},{v:"10",l:"10 pcs"}];
  return [{v:"18g",l:"18 g"},{v:"100",l:"100 g"},{v:"200",l:"200 g"},{v:"500",l:"500 g"}];
}

function addRow() {
  const r = document.getElementById("planTable").insertRow();
  r.innerHTML = `
    <td><select onchange="updateSize(this)"><option>Beans</option><option>Ground</option><option>Drip</option></select></td>
    <td><select></select></td>
    <td><select>${Object.keys(products).map(p=>`<option>${p}</option>`).join("")}</select></td>
    <td><input type="number" value="1" min="1"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">‚ùå</button></td>`;
  updateSize(r.cells[0].children[0]);
}
addRow();

function updateSize(sel) {
  const s = sel.parentElement.parentElement.cells[1].children[0];
  s.innerHTML="";
  getSizeOptions(sel.value).forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.v; opt.textContent=o.l; s.appendChild(opt);
  });
}

/* ========= BOM ========= */
function add(group,key,qty){
  if(!bom[group][key]) bom[group][key]={qty:0,cost:0};
  bom[group][key].qty+=qty;
}

function generateBOM(){
  bom={coffee:{},packaging:{},label:{}};
  summaryText=[];
  document.getElementById("summaryList").innerHTML="";
  generatedTime=new Date().toLocaleString();
  document.getElementById("generatedAt").textContent=generatedTime;

  document.querySelectorAll("#planTable tr").forEach((r,i)=>{
    if(i===0) return;
    const variant=r.cells[0].children[0].value;
    const size=r.cells[1].children[0].value;
    const product=r.cells[2].children[0].value;
    const qty=Number(r.cells[3].children[0].value);
    const bean=products[product];

    summaryText.push(`${variant} ${size} ‚Äì ${product} √ó ${qty}`);
    document.getElementById("summaryList").innerHTML+=`<li>${variant} ${size} ‚Äì ${product} √ó ${qty}</li>`;

    let coffeeQty=0, coffeeKey="";
    if(variant==="Beans"){coffeeKey=`${bean} beans`; coffeeQty=size==="18g"?18*qty:Number(size)*qty;}
    if(variant==="Ground"){coffeeKey=`${bean} ground coffee`; coffeeQty=size==="18g"?18*qty:Number(size)*qty;}
    if(variant==="Drip"){coffeeKey=`${bean} beans`; coffeeQty=size==="1pc"?10*qty:Number(size)*10*qty;}
    add("coffee",coffeeKey,coffeeQty);

    if(size==="18g"||size==="1pc") add("packaging","S size sachet",qty);
    else if((variant==="Drip"&&size==="5")||(variant!=="Drip"&&Number(size)<=200)) add("packaging","M size bag",qty);
    else add("packaging","L size bag",qty);

    if(variant==="Drip") add("packaging","Drip filter",size==="1pc"?qty:Number(size)*qty);
    add("label",`${product} ‚Äì ${variant}`,qty);
    if(variant==="Drip") add("label","Instruction label",qty);
  });

  render();
}

/* ========= PRICING ========= */
function loadPricing(){
  fetch("pricing.csv")
    .then(r=>r.text())
    .then(t=>{
      pricing={};
      t.trim().split("\n").slice(1).forEach(l=>{
        const [cat,mat,price]=l.split(",");
        pricing[`${cat}|${mat}`]=Number(price);
      });
      calculateCost();
    });
}

function calculateCost(){
  let totals={coffee:0,packaging:0,label:0};
  for(let g in bom){
    for(let m in bom[g]){
      const price=pricing[`${g}|${m}`]||0;
      const cost=bom[g][m].qty*price;
      bom[g][m].cost=cost;
      totals[g]+=cost;
    }
  }
  document.getElementById("coffeeCost").textContent=totals.coffee.toFixed(0);
  document.getElementById("packagingCost").textContent=totals.packaging.toFixed(0);
  document.getElementById("labelCost").textContent=totals.label.toFixed(0);
  document.getElementById("totalCost").textContent=(totals.coffee+totals.packaging+totals.label).toFixed(0);
}

function render(){
  ["coffee","packaging","label"].forEach(g=>{
    const t=document.getElementById(g+"Table");
    t.innerHTML="<tr><th>Material</th><th>Qty</th><th>Cost</th></tr>";
    for(let m in bom[g])
      t.innerHTML+=`<tr><td>${m}</td><td>${bom[g][m].qty}</td><td>${bom[g][m].cost.toFixed(0)}</td></tr>`;
  });
}

function downloadCSV(){ alert("Next step üòâ"); }
</script>

</body>
</html>
