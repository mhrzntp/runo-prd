<!DOCTYPE html>
<html>
<head>
  <title>Runo Production Planner</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    select, input, button { padding: 5px; }
    details { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
    summary { font-weight: bold; cursor: pointer; }
    .meta { margin-top: 15px; padding: 10px; background: #f5f5f5; }
  </style>
</head>
<body>

<h2>Runo Production Planner</h2>

<table id="planTable">
  <tr>
    <th>Variant</th>
    <th>Size</th>
    <th>Product</th>
    <th>Qty</th>
    <th>Action</th>
  </tr>
</table>

<button onclick="addRow()">‚ûï Add Product</button>
<button onclick="generateBOM()">Generate BOM</button>
<button onclick="downloadBOM()">Download BOM (CSV)</button>
<button onclick="downloadPricingTemplate()">Download Pricing Template</button>

<div class="meta">
  <strong>Generated at:</strong> <span id="generatedAt">-</span><br><br>
  <strong>Production Summary:</strong>
  <ul id="summaryList"></ul>
</div>

<details open><summary>‚òï Coffee</summary><table id="coffeeTable"></table></details>
<details open><summary>üì¶ Packaging</summary><table id="packagingTable"></table></details>
<details open><summary>üè∑Ô∏è Labels</summary><table id="labelTable"></table></details>

<script>
/* ===== MASTER DATA ===== */
const products = {
  "Toraja Soul": "Toraja Sapan",
  "Gayo Sunset": "Gayo Wine",
  "Preanger Sweets": "Red Preanger",
  "Ijen Dawn": "Ijen Raung",
  "Kerinci Breeze": "Kerinci",
  "Sumatera Classic": "Lampung Jantan"
};

const DRIP_DOSE = 10;
const SACHET_DOSE = 18;

let bom = { coffee:{}, packaging:{}, label:{} };
let summaryText = [];
let generatedTime = "";

/* ===== SIZE OPTIONS ===== */
function getSizeOptions(variant) {
  if (variant === "Drip") {
    return [
      { v: "1pc", l: "1 pc" },
      { v: "5", l: "5 pcs" },
      { v: "10", l: "10 pcs" }
    ];
  }
  return [
    { v: "18g", l: "18 g" },
    { v: "100", l: "100 g" },
    { v: "200", l: "200 g" },
    { v: "500", l: "500 g" }
  ];
}

/* ===== UI ===== */
function addRow(values = null, insertAfter = null) {
  const table = document.getElementById("planTable");
  const row = table.insertRow(insertAfter ? insertAfter.rowIndex + 1 : -1);

  row.innerHTML = `
    <td>
      <select onchange="updateSize(this)">
        <option>Beans</option>
        <option>Ground</option>
        <option>Drip</option>
      </select>
    </td>
    <td><select></select></td>
    <td>
      <select>${Object.keys(products).map(p => `<option>${p}</option>`).join("")}</select>
    </td>
    <td><input type="number" value="1" min="1"></td>
    <td>
      <button onclick="copyRow(this)">üìÑ</button>
      <button onclick="this.parentElement.parentElement.remove()">‚ùå</button>
    </td>
  `;

  updateSize(row.cells[0].children[0]);

  if (values) {
    row.cells[0].children[0].value = values.variant;
    updateSize(row.cells[0].children[0]);
    row.cells[1].children[0].value = values.size;
    row.cells[2].children[0].value = values.product;
    row.cells[3].children[0].value = values.qty;
  }
}

function copyRow(btn) {
  const row = btn.parentElement.parentElement;
  const values = {
    variant: row.cells[0].children[0].value,
    size: row.cells[1].children[0].value,
    product: row.cells[2].children[0].value,
    qty: row.cells[3].children[0].value
  };
  addRow(values, row);
}

function updateSize(sel) {
  const sizeSel = sel.parentElement.parentElement.cells[1].children[0];
  sizeSel.innerHTML = "";
  getSizeOptions(sel.value).forEach(o => {
    const opt = document.createElement("option");
    opt.value = o.v;
    opt.textContent = o.l;
    sizeSel.appendChild(opt);
  });
}

addRow();

/* ===== BOM LOGIC ===== */
function add(group, name, qty) {
  if (!bom[group][name]) bom[group][name] = { qty: 0 };
  bom[group][name].qty += qty;
}

function generateBOM() {
  bom = { coffee:{}, packaging:{}, label:{} };
  summaryText = [];
  document.getElementById("summaryList").innerHTML = "";

  generatedTime = new Date().toLocaleString();
  document.getElementById("generatedAt").textContent = generatedTime;

  document.querySelectorAll("#planTable tr").forEach((r,i)=>{
    if(i===0) return;

    const variant=r.cells[0].children[0].value;
    const size=r.cells[1].children[0].value;
    const product=r.cells[2].children[0].value;
    const qty=Number(r.cells[3].children[0].value);
    const bean=products[product];

    summaryText.push(`${variant} ${size} ‚Äì ${product} √ó ${qty}`);
    document.getElementById("summaryList").innerHTML +=
      `<li>${variant} ${size} ‚Äì ${product} √ó ${qty}</li>`;

    let coffeeKey="", coffeeQty=0;

    if(variant==="Beans"){
      coffeeKey=`${bean} beans`;
      coffeeQty=size==="18g"?18*qty:Number(size)*qty;
    }
    if(variant==="Ground"){
      coffeeKey=`${bean} ground coffee`;
      coffeeQty=size==="18g"?18*qty:Number(size)*qty;
    }
    if(variant==="Drip"){
      coffeeKey=`${bean} beans`;
      coffeeQty=size==="1pc"?10*qty:Number(size)*10*qty;
    }

    add("coffee",coffeeKey,coffeeQty);

    if(size==="18g"||size==="1pc") add("packaging","S size sachet",qty);
    else if((variant==="Drip"&&size==="5")||(variant!=="Drip"&&Number(size)<=200))
      add("packaging","M size bag",qty);
    else add("packaging","L size bag",qty);

    if(variant==="Drip")
      add("packaging","Drip filter",size==="1pc"?qty:Number(size)*qty);

    add("label",`${product} ‚Äì ${variant}`,qty);
    if(variant==="Drip") add("label","Instruction label",qty);
  });

  render("coffeeTable",bom.coffee);
  render("packagingTable",bom.packaging);
  render("labelTable",bom.label);
}

function render(id,data){
  const t=document.getElementById(id);
  t.innerHTML="<tr><th>Material</th><th>Qty</th></tr>";
  for(let k in data)
    t.innerHTML+=`<tr><td>${k}</td><td>${data[k].qty}</td></tr>`;
}

/* ===== CSV DOWNLOADS ===== */
function downloadBOM(){
  let csv=`# Runo Production BOM\n# Generated at: ${generatedTime}\n`;
  summaryText.forEach(s=>csv+=`# ${s}\n`);
  csv+=`\nCategory,Material,Quantity\n`;
  for(let g in bom)
    for(let m in bom[g])
      csv+=`${g},${m},${bom[g][m].qty}\n`;

  triggerDownload(csv,"runo-bom.csv");
}

function downloadPricingTemplate(){
  let rows=[
    "category,material,price_per_unit"
  ];

  Object.values(products).forEach(b=>{
    rows.push(`coffee,${b} beans,`);
    rows.push(`coffee,${b} ground coffee,`);
  });

  rows.push(
    "packaging,S size sachet,",
    "packaging,M size bag,",
    "packaging,L size bag,",
    "packaging,Drip filter,",
    "label,Instruction label,"
  );

  Object.keys(products).forEach(p=>{
    rows.push(`label,${p} ‚Äì Beans,`);
    rows.push(`label,${p} ‚Äì Ground,`);
    rows.push(`label,${p} ‚Äì Drip,`);
  });

  triggerDownload(rows.join("\n"),"pricing-template.csv");
}

function triggerDownload(content,filename){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([content],{type:"text/csv"}));
  a.download=filename;
  a.click();
}
</script>

</body>
</html>
